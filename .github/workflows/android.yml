#include <mod/amlmod.h>
#include <mod/logger.h>
#include <mod/config.h>

// 1. SETUP NG MOD INFO
// Format: UniqueID, ModName, Version, Author
// IMPORTANTE: Iwasan ang spaces o symbols (&) sa Author name para iwas error
MYMOD(com.madleg.ragdoll, RagdollPhysics, 1.0, Madleg_JuniorDjjr)

// 2. GLOBAL VARIABLES
Config* cfg = NULL;

// Settings Variables
int iNumSubsteps, iNumIPLInstances;
float fSimulationSpeed, fRagdollLinearDamping, fRagdollAngularDamping;
float fRagdollGravity, fBulletPower, fExplosionPower;
float fSurfaceFriction, fRagDollFriction, fRagDollRestitution;
float fRagDollJointDamping, fRagDollGetUpThreshold;
float fRagDollShapeMargin, fWorldShapeMargin, fDynamicObjectMass;
float fWorldMinX, fWorldMinY, fWorldMaxX, fWorldMaxY;
bool bVehicleShapeUseSpheres, bUseDynamicObjects;

// 3. ENTRY POINT (Ito ang main function na tinatawag ng AML)
extern "C" void OnModLoad() {
    // A. Setup Logger (Para makita mo sa logs kung gumagana)
    logger->SetTag("RagdollPhysics");
    logger->Info("Nagsisimula na mag-load ang Ragdoll Mod...");

    // B. Setup Config
    // Ang "RagDoll_physics" dito ay automatic na magiging "RagDoll_physics.ini"
    // Hahanapin ito sa: Android/data/com.rockstargames.gtasa/
    cfg = new Config("RagDoll_physics");

    // C. Reading Values (Binabasa ang INI)
    
    // [CONFIG] Section - Integers
    iNumSubsteps = cfg->GetInt("CONFIG", "iNumSubsteps", 5);
    iNumIPLInstances = cfg->GetInt("CONFIG", "iNumIPLInstances", 100000);

    // [CONFIG] Section - Floats
    fSimulationSpeed = cfg->GetFloat("CONFIG", "fSimulationSpeed", 1.0f);
    fRagdollLinearDamping = cfg->GetFloat("CONFIG", "fRagdollLinearDamping", 0.05f);
    fRagdollAngularDamping = cfg->GetFloat("CONFIG", "fRagdollAngularDamping", 0.8f);
    fRagdollGravity = cfg->GetFloat("CONFIG", "fRagdollGravity", 1.0f);
    fBulletPower = cfg->GetFloat("CONFIG", "fBulletPower", 1.0f);
    fExplosionPower = cfg->GetFloat("CONFIG", "fExplosionPower", 1.2f);
    fSurfaceFriction = cfg->GetFloat("CONFIG", "fSurfaceFriction", 0.9f);
    fRagDollFriction = cfg->GetFloat("CONFIG", "fRagDollFriction", 0.9f);
    fRagDollRestitution = cfg->GetFloat("CONFIG", "fRagDollRestitution", 0.1f);
    fRagDollJointDamping = cfg->GetFloat("CONFIG", "fRagDollJointDamping", 10.0f);
    fRagDollGetUpThreshold = cfg->GetFloat("CONFIG", "fRagDollGetUpThreshold", 0.5f);
    fRagDollShapeMargin = cfg->GetFloat("CONFIG", "fRagDollShapeMargin", 0.02f);
    fWorldShapeMargin = cfg->GetFloat("CONFIG", "fWorldShapeMargin", 0.01f);
    fDynamicObjectMass = cfg->GetFloat("CONFIG", "fDynamicObjectMass", 20000.0f);
    
    // World Coordinates
    fWorldMinX = cfg->GetFloat("CONFIG", "fWorldMinX", -4000.0f);
    fWorldMinY = cfg->GetFloat("CONFIG", "fWorldMinY", -4000.0f);
    fWorldMaxX = cfg->GetFloat("CONFIG", "fWorldMaxX", 4000.0f);
    fWorldMaxY = cfg->GetFloat("CONFIG", "fWorldMaxY", 4000.0f);

    // Booleans
    bVehicleShapeUseSpheres = cfg->GetBool("CONFIG", "bVehicleShapeUseSpheres", true);
    bUseDynamicObjects = cfg->GetBool("CONFIG", "bUseDynamicObjects", true);

    // D. Save Config (Optional: Para mabuo ang file kung wala pa)
    cfg->Save();

    logger->Info("Config Loaded Successfully!");
    
    // NOTE: Sa ibaba nito ilalagay ang code para sa .BIN parsing at Physics
}

